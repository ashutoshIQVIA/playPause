<!DOCTYPE html>
<html>
<!-- This is the working package of august release -->
<head>
    <script src="Common_3i0p1.js" type="text/javascript"></script>

    <meta charset="utf-8" />
    <title>slide</title>
    <link href="css/style.css" rel="stylesheet" type="text/css" />
    <link href="css/anim.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" src="js/jquery-3.6.0.min.js"></script>
    <script src="js/jquery-3.6.0.min.js"></script>
    <script src="Common.js" type="text/javascript"></script>

</head>
<!-- checking git commits -->

<body id="body-container">
    <div id="main">
        <div class="iframe">
            <iframe src="/media/defaultSlide/index.html" scrolling="no" frameborder="0" width="100%" height="100%"
                class="mainIfram" id="my-iframe" currentValue=""></iframe>
        </div>

        <div class="navigation navSlider" id="customNavigation">
            <!-- <div class="navItem navItemSlide1"></div> -->
            <div class="navItem">
                <div class="navContainer">
                    <img class="navImage" src="" alt="" />
                    <a class="navAnchor" currentValue=""></a>
                </div>
            </div>
        </div>

        <!-- <a class="next round" id="nextClick" onclick="clickNextbutton()"></a> -->
    </div>
</body>

</html>
<script>

    // setting callback where survey json will be passed
    // CLMPlayer.registerEventListener("surveyflowjsonloaded", onSurveyLoadedGlobal); //uncomment
    let iframeDiv = document.getElementsByClassName('iframe')[0];
    const iframe = iframeDiv.querySelector('iframe')

    let wrapper = document.getElementById("body-container");
    let outer = document.getElementById("main");
    let maxWidth = outer.clientWidth;
    let maxHeight = outer.clientHeight;
    // let newsequenceData = ["34_Reswas_LS_Slide01", "34_Wokadine_Wound_Slide01"]; // uncomment
    let iFrameContainer = "";
    let iframeCurrentValue = {};

    window.addEventListener("resize", resize);
    resize();
    function resize() {
        let scale,
            width = window.innerWidth,
            height = window.innerHeight;
        scale = Math.min(width / maxWidth, height / maxHeight);
        outer.style.transform = "scale(" + scale + ")";
    }

    // function onSurveyLoadedGlobal(flowJson) {
    //     var jsonString = JSON.stringify(flowJson);
    //     // iframe.contentWindow['survey'] = jsonString;
    //     iframe.contentWindow.initSurvey(jsonString)
    // }
</script>

<script>
    let callID;
    let callIDUpsert;
    let DRLOpenINdex;
    let findSlideResult;
    let productdataDb;

    let drlTotalData = 0,
        RecordLegth = 0;

    let sequenceData = [],
        configDataJson = [],
        productData = [],
        productMessageData = [],
        slideOrder = [],
        DRLProductName = [];

    let DRLSequenceName = [],
        DRLProduct = [],
        DRLOrder = [],
        DRLProductMessage = [];

    let drlPreviousSlide = "";
    let productDataUpsert = []
    let drlErrorSlides = [];

    let clickstreamData = [];
    let clickStreamRAWData = [];
    let CallDetailsUpsertData = [];
    let errorSlideArray = [];
    let currentSlide = {
        slide: '',
        start: ''
    };

    let previousSlide = {
        slide: '',
        start: '',
        product: '',
        message: '',
        reference: ''
    };

    let productOrder = {
        productId: '',
        productRefdata: ''
    };


    let messageData = {
        productId: '',
        messageId: ''
    };

    let iframeSrc = document.querySelector(".mainIfram");
    let productmessagedataDb;
    let CallPresentationID;
    let sharedProductData;

    CLMPlayer.registerEventListener("viewappearing", viewAppearingHandler);
    CLMPlayer.registerEventListener("returntocallbuttonpress", CallbuttonPlayerHandler);

    function getAccountRecords() {

        try {
            if (allData != undefined || allData != [] || allData != null) {

                let accountIds = allData.customers[0].id;
                let territoryNames = allData.currentTerritoryName;
                let territoryName = "'" + territoryNames + "'";
                accountID = "'" + accountIds + "'";
                CLMPlayer.fetch(
                    "SELECT id, name, OCE__Account__c, OCE__Territory__c, DRL_PresentationSlideOrder__c FROM OCE__AccountTerritoryFields__c where OCE__Account__c =" +
                    accountID +
                    " AND OCE__Territory__c = " +
                    territoryName,
                    "getATFRecordsCallback"
                );
            } else {
                getConfigData();
            }
        } catch {
            getConfigData();
        }
    }
    // this function retrieve slideorder from the custom object
    function getATFRecordsCallback(data) {
        if (data.state === "success") {

            try {
                let newRecord = data.records[0].DRL_PresentationSlideOrder__c; //retrive the field data
                sequenceData = Array.from(new Set(newRecord.split(","))); //Remove the duplicate Data
                getConfigData();
            } catch (error) {
                sequenceData = [];
                getConfigData();
            }
        } else {
            sequenceData = [];
            getConfigData();
        }
    }

    function clickNext(seqID, slideName) {
        try {
            CLMPlayer.gotoSlide(seqID, slideName, null);
        } catch (err) {
            // console.log(err);
        }
    }


    function clickNextbutton(swipe) {
        var x = document.getElementById("customNavigation");
        if (x.style.height == "24%" || x.style.height == "" || swipe == "noswipe") {
            x.style.height = "0%";
        } else {
            x.style.height = "24%";
        }
    }
    //function to match sequences data of custom object
    function getConfigData() {
        configDataJson = DRLSequenceName;
        if (sequenceData == undefined || sequenceData == [] || sequenceData == "") {
            sequenceData = [];
            for (i = 0; i < configDataJson.length; i++) {
                sequenceData.push(configDataJson[i]);
                continue;
            }
        }

        for (i = 0; i < sequenceData.length; i++) {
            for (j = 0; j <= configDataJson.length; j++) {
                if (j == configDataJson.length) {
                    // console.log("condition is true:" + sequenceData[i].trim());
                    findSlideResult = drlErrorSlides.find(
                        (ele) => ele == sequenceData[i].trim()
                    );
                    if (!findSlideResult) {
                        iFrameContainer += `<div class="navItem navItemSlide${sequenceData[
                            i
                        ].trim()}">
                    <div class="navContainer" onclick = "updateIfram(${DRLOrder[j]
                            },this.id, '${sequenceData[
                                i
                            ].trim()}')" id = "navAnchor${sequenceData[
                                i
                            ].trim()}" currentvalue="Inactive">
                        <a  id = "navItemSlide${sequenceData[
                                i
                            ].trim()}" class="navImageAnchor">
                     <img class = "navImage" src="media/images/SlideError.jpg" alt=""></a>
                            <a class = 'navAnchor' value='${sequenceData[
                                i
                            ].trim()}' currentValue = "" >${sequenceData[
                                i
                            ].trim()}</a>
                             </div>
                        </div>
                        `;
                        drlErrorSlides.push(sequenceData[i].trim());
                    }
                } else {
                    if (configDataJson[j] == sequenceData[i].trim()) {
                        //
                        iFrameContainer += `<div class="navItem navItemSlide${DRLOrder[j]}">
                    <div class="navContainer" onclick = "updateIfram(${DRLOrder[j]},this.id, '${configDataJson[j]}')" id = "navAnchor${DRLOrder[j]}" currentvalue="Inactive">
                        <a  id = "navItemSlide${DRLOrder[j]}" class="navImageAnchor">
                     <img class = "navImage" src="slides/${configDataJson[j]}/01_thumbnail.jpg" alt=""></a>
                            <a class = 'navAnchor' value='${DRLOrder[j]}' currentValue = "" >${configDataJson[j]}</a>
                             </div>
                        </div>
                        `;
                        break;
                    }
                }
            }
        }
        loadiFrameData(iFrameContainer);
    }
    // this function will load iFrame data

    function loadiFrameData(iFrameContainer) {
        // document.getElementById("customNavigation").style.height = "0%";
        document.getElementById("customNavigation").innerHTML = iFrameContainer; //it will print all navigation in the HTML body
        currentValueAnchor = document.querySelectorAll(".navAnchor");
        currentValueImage = document.querySelectorAll(".navImageAnchor");
        if (sequenceData[0].trim() == undefined || sequenceData[0].trim() == "") {
            //if no data is present for a HCP then first slide will be the first slide
            updateIfram(sequenceData[0]);
        }
        //to get the unique prodict and pass it calldetails to identify unshared products
        try {
            let uniqeProductArray = [...new Set(DRLProduct.filter(item => item != null && item !== undefined))];
            let ProdutsForQuery = uniqeProductArray.map(element => `'${element}'`).join(', ');
            fetchSharedProducts(ProdutsForQuery)
        } catch (err) {
            // CLMPlayer.alert('some error' + err)
        }
        let mysequenceData = sequenceData[0].trim();
        updateIfram(0, this.id, mysequenceData); //if no data present for a HCP then first seq will be the first slide
    }

    function fetchSharedProducts(DRLproducts) {
        //  let DRLProductquery = "SELECT id, name FROM OCE__ProducequenceData = newRecord.split(",");t__c WHERE id in(" + DRLproducts + ")"
        //  CLMPlayer.alert("The Query  iS" + DRLProductquery + typeof(DRLproducts));

        try {
            CLMPlayer.fetchWithParams(
                "SELECT id, name FROM OCE__Product__c WHERE id in(" + DRLproducts + ")",
                "{‘batchSize‘: 100}",
                "getSharedProducts"
            );
        } catch (err) {
            // CLMPlayer.alert('there is error with the query')
        }

    }

    function getSharedProducts(data) {
        try {
            sharedProductData = data.records
        } catch (err) {
            // CLMPlayer.alert("Error" + err)
        }

    }

    function viewAppearingHandler() {
        try{
            CLMPlayer.disableDismiss();
        }catch(err){
            CLMPlayer.alert(err)
        }
        
    }

    // This function will be triggered from the logo slide, which will validate the array list of the slides, validate it and then call the update iFrame function
    function pickFromList(ArrayData) {
        //assumed received ["test1", "test2","Test3"]
        for (i = 0; i < ArrayData.length; i++) {
            let findMySlide = sequenceData.findIndex((data) => data == ArrayData[i]);
            if (findMySlide >= 0) {
                updateIfram('', '', ArrayData[i])
                break;
            }
        }
    }

    // THis is the main logic which loads the iframe based on events
    function updateIfram(slideIndex, anchorId, slideName) {

        if (slideIndex == undefined || slideName == undefined) {
        }
        let slide = slideName ? slideName : slideIndex;
        // console.log("THis is the index of slide" + slideIndex);
        let index = configDataJson.findIndex((data) => data == slide);
        let slideIorder = sequenceData.findIndex((data) => data == slide);
        let errorSlide = drlErrorSlides.find((ele) => ele == slide);
        if (slideIorder >= 0) {
            if (errorSlide) {
                iframeSrc.src = `media/defaultSlide/index.html`;
                errorSlideArray.push(slide)
            } else {
                iframeSrc.src = `slides/${slide}/index.html`;
                //saving data in the calldetails and call message object
            }
            // this is for the click stream //
            try {
                currentSlide.start = new Date(); //current DateTime
                if (previousSlide.slide !== "") {
                    let currentDuration = diff_minutes(
                        currentSlide.start,
                        previousSlide.start
                    );
                    let endSlide = currentSlide.start;

                    if (currentDuration >= 1) {
                        if (callIDUpsert) {
                            let productOrder = {
                                // slideOrder: slideIorder + 1,
                                productId: previousSlide.product,
                                productRefdata: previousSlide.reference
                            };

                            if (previousSlide.product !== '') {
                                productData.push(productOrder);
                            }

                            let messageData = {
                                productId: previousSlide.product,
                                messageId: previousSlide.message
                            };

                            if (previousSlide.message == '' || previousSlide.message == null || previousSlide.message == 'null') {
                            }
                            else {
                                let productmessageIndex = productmessagedataDb.findIndex(ele => ele.OCE__ProductMessage__c == previousSlide.message)
                                if (productmessageIndex < 0) {
                                    // CLMPlayer.alert("message is:" + DRLProductMessage[index] + "-Length-" + productMessageData.length)
                                    productMessageData.push(messageData);
                                    // CLMPlayer.alert("data is +" + previousSlide.message)
                                } else {
                                    // CLMPlayer.alert("This data already present" + previousSlide.message + "Length is :" + productMessageData.length)
                                }
                            }

                        }

                        clickStreamRAWData.push({
                            currentDuration: currentDuration,
                            previousSlideTime: previousSlide.start,
                            currentSlideTime: currentSlide.start,
                            previousSlide: previousSlide.slide,
                            PreviousProduct: previousSlide.product,
                            PreviousMessage: previousSlide.message
                        })


                    }
                }
                previousSlide.start = new Date();
                previousSlide.product = DRLProduct[index];
                previousSlide.slide = slide;
                previousSlide.message = DRLProductMessage[index];
                previousSlide.reference = DRLProductName[index];

            } catch (err) {
                // CLMPlayer.alert("Error occured:" + err); //uncomment
            }
            // this is end for the click stream //

            for (i = 0; i < sequenceData.length; i++) {
                if (sequenceData[i].trim() == slide) {
                    // console.log(sequenceData[i].trim() + "clicked");
                    document.getElementsByClassName("navImage")[i].classList.add("selectedItem");
                } else {
                    document
                        .getElementsByClassName("navImage")[i].classList.remove("selectedItem");
                }
            }
            let a = document.getElementsByClassName("navContainer");
            iframeSrc.setAttribute("currentvalue", slide);
            drlPreviousSlide = slide; //Save this slide for th previous use

            let DRLscrollNavigation = document.getElementById('customNavigation');
            let DRLscrollleftOffset = document.getElementsByClassName('selectedItem')[0].offsetLeft;
            let DRLScrollviewportLeft = document.getElementsByClassName('selectedItem')[0].getBoundingClientRect().left
            if (DRLScrollviewportLeft > 850 || DRLScrollviewportLeft < 20) {
                DRLscrollNavigation.scrollLeft = DRLscrollleftOffset - 20
            }
            // CLMPlayer.alert(previousSlide.slide + "Added Slide" + clickStreamRAWData.length)
            // if (clickStreamRAWData.length > 1) {
            //     CallbuttonPlayerHandler();
            // }
        }
    }

    let mydubbleTap, myPreviousTap, myCurrentTouch;
    document
        .getElementById("my-iframe")
        .addEventListener("load", drlCheckClickEvent);
    function drlCheckClickEvent() {
        let mytouch, mytouchend;
        let touchPointA, TouchPointB, myTouchDuration, doubleTapDuration;
        let swipeTimeout;
        let doubleTapTimeout = null;
        let lastTapTime = 0;
        let iframe = document.getElementById("my-iframe");
        iframe.contentDocument.body.removeEventListener("touchstart", checkLeftTouch);
        iframe.contentDocument.body.removeEventListener("touchend", checkRightTouch);

        iframe.contentDocument.body.addEventListener("touchstart", checkLeftTouch);
        iframe.contentDocument.body.addEventListener("touchend", checkRightTouch);

        function checkLeftTouch(e) {
            mytouch = e;
            touchPointA = mytouch.changedTouches[0].screenX;
            clickNextbutton("noswipe");
            // CLMPlayer.alert(mytouch.timeStamp + "Touch Started")
            clearTimeout(swipeTimeout); // Clear any previous swipe timeout
            swipeTimeout = null;
            checkDoubleTap();

        }

        function checkRightTouch(e) {
            mytouchend = e;
            touchPointB = mytouchend.changedTouches[0].screenX;
            clearTimeout(swipeTimeout); // Clear any previous timeout
            swipeTimeout = setTimeout(checkSwipe, 100); // Delay execution of checkSwipe by 100ms
        }

        function checkDoubleTap() {
            const currentTime = Date.now();
            const timeSinceLastTap = currentTime - lastTapTime;
            lastTapTime = currentTime;

            if (timeSinceLastTap < 300) {
                if (doubleTapTimeout) {
                    clearTimeout(doubleTapTimeout);
                    doubleTapTimeout = null;
                    clickNextbutton();
                    console.log("Double tap detected");
                    // Call the function for handling double tap
                }
            } else {
                doubleTapTimeout = setTimeout(function () {
                    doubleTapTimeout = null;
                }, 300);
            }
        }

        function checkSwipe() {
            const myTouchDuration = mytouchend.timeStamp - mytouch.timeStamp;
            const touchDurationDubleTap = mytouch.timeStamp - myPreviousTap;

            if (touchPointA > touchPointB && touchPointA - touchPointB > 40 && myTouchDuration < 250) {
                console.log("left Swipe");
                iframeLoadData("left");
            } else if (touchPointB > touchPointA && touchPointB - touchPointA > 40 && myTouchDuration < 250) {
                console.log("right Swipe");
                iframeLoadData("right");
            } else if (touchDurationDubleTap < 300 && touchDurationDubleTap > 0) {
                console.log("doubleTap");
                // clickNextbutton();
            } else {
                console.log("zero touch");
                // clickNextbutton("noswipe");
            }
        }

        // Rest of your code...

        function iframeLoadData(swipeAction) {
            if (iframeSrc.getAttribute("currentvalue") === "") {
                iframeSrc.setAttribute("currentvalue", sequenceData[0]);
            }

            let updatedIndex = -1;
            for (let i = 0; i < sequenceData.length; i++) {
                if (sequenceData[i].trim() === iframeSrc.getAttribute("currentvalue")) {
                    updatedIndex = i;
                    break;
                }
            }

            if (updatedIndex !== -1) {
                if (swipeAction === "left") {
                    updatedIndex += 1;
                } else if (swipeAction === "right") {
                    updatedIndex -= 1;
                }

                if (sequenceData[updatedIndex]) {
                    updateIfram(sequenceData[updatedIndex].trim());
                    // event.stopPropagation();
                }
            }
        }
    }

    // feching fileds from OCE__CallDetail__c
    function fetchCallDetails() {
        CLMPlayer.fetchWithParams(
            "SELECT id, OCE__Product__c,OCE__Call__c,OCE__OfflineUniqueId__c,OCE__DisplayOrder__c FROM OCE__CallDetail__c where OCE__Call__c =" + callID,
            "{‘batchSize‘: 100}",
            "getProductdata"
        );

    }

    function getProductdata(data) {
        productdataDb = data.records;
        // DRLOpenINdex = productdataDb.length;
        const displayOrders = data.records.map(record => {
            const number = parseInt(record.OCE__DisplayOrder__c, 10);
            return isNaN(number) || !isFinite(number) ? 0 : number;
        });

        const largestDisplayOrder = Math.max(...displayOrders);

        if (largestDisplayOrder === -Infinity) {
            DRLOpenINdex = 0
        } else {
            DRLOpenINdex = largestDisplayOrder
        }
    }


    function diff_minutes(endTime, startTime) {

        const diff = Math.abs(endTime - startTime);
        let DiffUsageDuration = diff / 1000;
        if (DiffUsageDuration > 1) {
            return Math.round(DiffUsageDuration); //
        } else {
            return 0
        }

    }

    //end of contains the clickStream logic

    //cancel button save logic

    function CancelbuttonPlayerHandler() {
        let myCallID = allData.calls[0].id
        myCallID = "'" + myCallID + "'";
        try {
            CLMPlayer.fetch(
                "SELECT id, DRL_PresentationClickedCancelDateTime__c FROM OCE__Call__c WHERE id = " + myCallID,
                "upsertCancelButton"
            );
        } catch (err) {
            // saveDataOnCancelButton()
        }
    }

    function saveDataOnCancelButton(CancelRecord) {

        try {
            CLMPlayer.upsert([{
                'sobject': 'OCE__Call__c',
                'id': callIDUpsert,
                'DRL_PresentationClickedCancelDateTime__c': CancelRecord,
                // 'DRL_PresentationClickedCancelDateTime__c': CancelRecord,
                'DRL_IsClickedOnCancelAfterCLM__c': true
            }], 'cancelCallBack')
        } catch (err) {
            // CLMPlayer.alert('error come to the save' + err)
        }
    }

    function cancelCallBack(data) {
        // CLMPlayer.alert('Worked' + JSON.stringify(data))
    }

    function upsertCancelButton(data) {
        let CancelRecord
        try {
            if (data.state == "success") {
                // CLMPlayer.alert(JSON.stringify(data));
                if (data.records[0].DRL_PresentationClickedCancelDateTime__c == undefined || data.records[0].DRL_PresentationClickedCancelDateTime__c == 'undefined' || data.records[0].DRL_PresentationClickedCancelDateTime__c == null || data.records[0].DRL_PresentationClickedCancelDateTime__c == 'null' || data.records[0].DRL_PresentationClickedCancelDateTime__c == '') {
                    CancelRecord = new Date().toISOString().substring(0, 19) + ".000+0000";
                    saveDataOnCancelButton(CancelRecord)
                } else {
                    // CLMPlayer.alert("on else condition" + data.records[0].DRL_PresentationClickedCancelDateTime__c)
                    CancelRecord = data.records[0].DRL_PresentationClickedCancelDateTime__c;
                    CancelRecord = CancelRecord + ',' + new Date().toISOString().substring(0, 19) + ".000+0000";
                    saveDataOnCancelButton(CancelRecord)
                }

            } else {
                // CLMPlayer.alert('SOME ERROR OCCURED')
            }
        } catch (err) {
            // CLMPlayer.alert('There is some error on catch' + err)
        }

    }

    //end of cancel buttom logic

    // this function upsert calldetails to salesforce it will triggered on call button click

    function CallbuttonPlayerHandler() {

        //this is just to check if it holds for 7sec 
        // setTimeout(() => {
        //     CLMPlayer.enableDismiss();
        // }, 15000);

        if (allData.customers[0].id) {
            let currentDuration = diff_minutes(previousSlide.start, new Date());
            if (currentDuration >= 1) {
                if (callIDUpsert) {

                    productOrder = {
                        // slideOrder: slideIorder + 1,
                        productId: previousSlide.product,
                        productRefdata: previousSlide.reference
                    };

                    if (previousSlide.product !== '') {
                        productData.push(productOrder);
                    }

                    messageData = {
                        productId: previousSlide.product,
                        messageId: previousSlide.message
                    };

                    if (previousSlide.message == '' || previousSlide.message == null || previousSlide.message == 'null') {
                    }
                    else {
                        let productmessageIndex = productmessagedataDb.findIndex(ele => ele.OCE__ProductMessage__c == previousSlide.message)
                        if (productmessageIndex < 0) {
                            // CLMPlayer.alert("message is:" + DRLProductMessage[index] + "-Length-" + productMessageData.length)
                            productMessageData.push(messageData);
                        }
                    }

                }

                clickStreamRAWData.push({
                    currentDuration: currentDuration,
                    previousSlideTime: previousSlide.start,
                    currentSlideTime: new Date(),
                    previousSlide: previousSlide.slide,
                    PreviousProduct: previousSlide.product,
                    PreviousMessage: previousSlide.message
                })

            }
        }
        if (productData.length >= 1) {

            const isCLM = true;
            let uniqueProductData = [
                ...new Map(
                    productData.map((product) => [product["productId"], product])
                ).values(),
            ];
            // let fetchproductDetails = fetchCallDetails();
            try {
                for (i = 0; i < uniqueProductData.length; i++) {
                    if (uniqueProductData[i].productId == null || uniqueProductData[i].productId === null || uniqueProductData[i].productId == 'null') {
                    }
                    else {
                        let indexProduct = productdataDb.filter(productidFetch => productidFetch.OCE__Product__c == uniqueProductData[i].productId)
                        if (!indexProduct.length) {
                            let ValidProduct = sharedProductData.findIndex(ele => ele.id == uniqueProductData[i].productId)
                            if (ValidProduct >= 0) {
                                productdataDb.push({ OCE__Call__c: callIDUpsert, 'OCE__Product__c': uniqueProductData[i].productId });
                                productDataUpsert.push({
                                    OCE__Call__c: callIDUpsert,
                                    OCE__Product__c: uniqueProductData[i].productId
                                });
                                DRLOpenINdex = DRLOpenINdex + 1;
                                CLMPlayer.upsert([{ 'sobject': 'oce__calldetail__c', 'OCE__Call__c': callIDUpsert, 'oce__product__c': uniqueProductData[i].productId, 'oce__isclm__c': isCLM, 'oce__displayorder__c': DRLOpenINdex, 'OCE__ProductRefData__c': uniqueProductData[i].productRefdata, 'OCE__ProductNameRef__c': uniqueProductData[i].productRefdata }], 'upsertCallDetailCallback');
                            }
                        }
                    }
                    if (i == uniqueProductData.length - 1) {
                        fetchCallDetailsObject()
                    }
                }
            } catch (err) {

            }
        } else {
            fetchCallDetailsObject()
        }
    }

    // functoin to fetch calldetail information from salesforce
    function fetchCallDetailsObject() {

        CLMPlayer.fetchWithParams(
            "SELECT id, OCE__Product__c,OCE__Call__c,OCE__OfflineUniqueId__c FROM OCE__CallDetail__c where OCE__Call__c = " + callID,
            "{‘batchSize‘: 100}",
            "reFetchCallDetails"
        );
    }

    //function to assign fetch records of call information from salesforce to CallDetailsUpsertData 
    function reFetchCallDetails(data) {
        CallDetailsUpsertData = [];
        CallDetailsUpsertData = data.records;
        productdataDb = CallDetailsUpsertData;
        CallbuttonPlayerHandlerProductMessage();
    }

    function upsertCallDetailCallback(data) {

    }

    // this function upsert callmessages to salesforce
    function CallbuttonPlayerHandlerProductMessage() {

        if (productMessageData.length > 0) {
            // CLMPlayer.alert('length of the product is:' + productMessageData.length)
            try {
                let upsertRecords = [];
                let callDetailsObject;
                let producMessageCallDetail;
                const isCLM = true;
                let uniqueProductMessageData = [
                    ...new Map(
                        productMessageData.map((product) => [product["messageId"], product])
                    ).values(),
                ];
                //changed the approch - now instead of adding every record in array and then using upsert, we are now using for loop to upsert the data. - 12/06/23 
                if (uniqueProductMessageData.length > 0) {
                    for (i = 0; i < uniqueProductMessageData.length; i++) {
                        let getDuplicateMessageDataIndex = productmessagedataDb.findIndex(ele => ele.OCE__ProductMessage__c == uniqueProductMessageData[i].messageId)
                        if (getDuplicateMessageDataIndex >= 0) {
                            // CLMPlayer.alert("Duplicate Data found")
                        } else {
                            let callIDDetailsIndex = CallDetailsUpsertData.findIndex(ele => ele.OCE__Product__c == uniqueProductMessageData[i].productId) //assume it is 10
                            if (callIDDetailsIndex >= 0) { //check if product is available for the message call
                                callDetailsObject = CallDetailsUpsertData[callIDDetailsIndex].id;  //if yes then this is the object can be used to insert the call details ID

                                CLMPlayer.upsert([{
                                    'sobject': 'OCE__CallMessage__c',
                                    'OCE__ProductMessage__c': uniqueProductMessageData[i].messageId,
                                    'OCE__Product__c': uniqueProductMessageData[i].productId,
                                    'OCE__Call__c': callIDUpsert,
                                    'OCE__isCLM__c': isCLM,
                                    'OCE__CallDetail__c': callDetailsObject,
                                    'OCE__Account__c': allData.customers[0].id
                                }], 'upsertCallMessageCallbackPlaceHolder')
                            }
                        }
                    }
                    upsertCallMessageCallback();

                }

            } catch (err) {
                fetchProductmessageAfterUpser()

            }
        } else {
            fetchProductmessageAfterUpser()
        }
    }

    function upsertCallMessageCallbackPlaceHolder(data) {

    }

    // fech fileds from Productmessages after initial upsert
    function upsertCallMessageCallback(data) {
        // CLMPlayer.alert("message Data is:" + JSON.stringify(data)); //uncomment
        fetchProductmessageAfterUpser()
    }

    // fech fileds from Productmessages after initial upsert
    function fetchProductmessageAfterUpser() {

        CLMPlayer.fetchWithParams(
            "SELECT id, OCE__Product__c, OCE__ProductMessage__c,OCE__ProductMessageRefData__c, OCE__ProductRefData__c, OCE__CallDetail__c FROM OCE__CallMessage__c WHERE OCE__Call__c =" + callID + "order by CreatedDate ASC",
            "{‘batchSize‘: 100}",
            "onProductmessageCallBackUpsert"
        );

    }

    function refetchProductmessageAfterUpser() {

        CLMPlayer.fetchWithParams(
            "SELECT id, OCE__Product__c, OCE__ProductMessage__c,OCE__ProductMessageRefData__c, OCE__ProductRefData__c, OCE__CallDetail__c FROM OCE__CallMessage__c WHERE OCE__Call__c =" + callID + "order by CreatedDate DESC",
            "{‘batchSize‘: 100}",
            "ReonProductmessageCallBackUpsert"
        );

    }

    function ReonProductmessageCallBackUpsert(data) {
        let NewCallMessageArray = data.records;
        clickstreamData = clickstreamData.concat(NewCallMessageArray.filter(obj2 => !clickstreamData.some(obj1 => obj1.OCE__ProductMessage__c === obj2.OCE__ProductMessage__c)));
        productmessagedataDb = clickstreamData;
        performClickStreamUpsert();
    }

    function onProductmessageCallBackUpsert(data) {
        if (data.records.length > 99) {
            clickstreamData = data.records
            refetchProductmessageAfterUpser()
        } else {
            clickstreamData = data.records
            productmessagedataDb = clickstreamData;
            performClickStreamUpsert();
        }

    }

    // upserting clickstrem metrics details to salesforce 
    async function performClickStreamUpsert() {
        let DRLCallDetailsID
        let DRLCallMessageID
        let invalidSlide
        // let deletemyArray = []
        if (clickStreamRAWData.length > 0) {
            // fetchProductmessageAfterUpser()
            try {
                let CallupsertRecords = [];
                for (i = 0; i < clickStreamRAWData.length; i++) { //this have the data of callmessage object on everyclick
                    DRLCallMessageID = ''
                    DRLCallDetailsID = ''
                    CallMessageIndex = clickstreamData.findIndex(ele => ele.OCE__ProductMessage__c == clickStreamRAWData[i].PreviousMessage)
                    if (CallMessageIndex >= 0) {
                        DRLCallDetailsID = clickstreamData[CallMessageIndex].OCE__CallDetail__c
                        DRLCallMessageID = clickstreamData[CallMessageIndex].id
                    } else {
                        CallMessageIndex = CallDetailsUpsertData.findIndex(ele => ele.OCE__Product__c == clickStreamRAWData[i].PreviousProduct)
                        if (CallMessageIndex >= 0) {
                            DRLCallDetailsID = CallDetailsUpsertData[CallMessageIndex].id
                        }
                    }

                    invalidSlide = errorSlideArray.find((ele) => ele == clickStreamRAWData[i].previousSlide);

                    //changed the approch - now instead of adding every record in array and then using upsert, we are now using for loop to upsert the data. - 12/06/23 
                    if (DRLCallDetailsID && DRLCallMessageID) {
                        await CLMPlayer.upsert([{
                            'sobject': 'OCE__ClickStreamMetric__c',
                            'OCE__UsageDuration__c': clickStreamRAWData[i].currentDuration,
                            'OCE__UsageStartTime__c': clickStreamRAWData[i].previousSlideTime,
                            'OCE__UsageEndTime__c': clickStreamRAWData[i].currentSlideTime,
                            'OCE__PageId__c': clickStreamRAWData[i].previousSlide,
                            'OCE__Call__c': callIDUpsert,
                            'OCE__CallDetail__c': DRLCallDetailsID,
                            'OCE__CallPresentation__c': CallPresentationID,
                            'OCE__CallMessage__c': DRLCallMessageID,
                            'OCE__Presentation__c': allData.presentations[allData.presentationIndex].id
                        }], 'upsertClickStreamMetricsCallback')
                    } else if (DRLCallDetailsID) {
                        await CLMPlayer.upsert([{
                            'sobject': 'OCE__ClickStreamMetric__c',
                            'OCE__UsageDuration__c': clickStreamRAWData[i].currentDuration,
                            'OCE__UsageStartTime__c': clickStreamRAWData[i].previousSlideTime,
                            'OCE__UsageEndTime__c': clickStreamRAWData[i].currentSlideTime,
                            'OCE__PageId__c': clickStreamRAWData[i].previousSlide,
                            'OCE__Call__c': callIDUpsert,
                            'OCE__CallPresentation__c': CallPresentationID,
                            'OCE__CallDetail__c': DRLCallDetailsID,
                            'OCE__Presentation__c': allData.presentations[allData.presentationIndex].id
                        }], 'upsertClickStreamMetricsCallback')

                    } else if (!invalidSlide) {
                        await CLMPlayer.upsert([{
                            'sobject': 'OCE__ClickStreamMetric__c',
                            'OCE__UsageDuration__c': clickStreamRAWData[i].currentDuration,
                            'OCE__UsageStartTime__c': clickStreamRAWData[i].previousSlideTime,
                            'OCE__UsageEndTime__c': clickStreamRAWData[i].currentSlideTime,
                            'OCE__PageId__c': clickStreamRAWData[i].previousSlide,
                            'OCE__Call__c': callIDUpsert,
                            'OCE__CallPresentation__c': CallPresentationID,
                            'OCE__Presentation__c': allData.presentations[allData.presentationIndex].id
                        }], 'upsertClickStreamMetricsCallback')
                    }
                }
                CLMPlayer.enableDismiss()

            } catch (err) {

            }
            // CLMPlayer.enableDismiss()
        }
    }

    function upsertClickStreamMetricsCallback(data) {
        // clickStreamRAWData = []
    }

    function fetchOCECallPresentation() {
        try {
            let myCallID = allData.calls[0].id
            myCallID = "'" + myCallID + "'";

            let myPresentationID = allData.presentations[allData.presentationIndex].id;
            myPresentationID = "'" + myPresentationID + "'";

            CLMPlayer.fetch(
                "SELECT id FROM OCE__CallPresentation__c where OCE__Call__c = " + myCallID + "AND OCE__Presentation__c = " + myPresentationID,
                "getfetchOCECallPresentation"
            );
        } catch (err) {
            CLMPlayer.alert(err)
        }

    }

    function getfetchOCECallPresentation(data) {
        CallPresentationID = data.records[0].id;
    }

    function getRecordCount() {
        setTimeout(() => {
            try {
                let activeCallID = allData.calls[0].id
                callID = "'" + activeCallID + "'";
                callIDUpsert = activeCallID;
            } catch {
                CLMPlayer.alert("Please use the General Presentation")
                if (!allData.customers[0].id) {
                    return;
                }
            }

            let presentationName =
                allData.presentations[allData.presentationIndex].name;
            // let presentationName1 = "'" + presentationName + "'";
            let presentationName1 = "'" + '34-Aqura SG Segmentation Presentation_TN_OD' + "'"
            CLMPlayer.fetchWithParams(
                "SELECT DRL_ProductMessage__c, DRL_SequenceName__c, DRL_Product__c,DRL_Product__r.Name, DRL_DefaultSequenceOrder__c, DRL_MasterPresentationName__c FROM DRL_SequenceProductMessage__c WHERE DRL_MasterPresentationName__c =" + presentationName1 + "order by DRL_DefaultSequenceOrder__c",
                "{‘batchSize‘: 100}",
                "getRecordCountCallback"
            );
        }, 100);
    }

    function getAdditionalData() {
        let AllpresentationName =
            allData.presentations[allData.presentationIndex].name;
        // let AllpresentationNameNew = "'" + AllpresentationName + "'";
        let AllpresentationNameNew = "'" + '34-Aqura SG Segmentation Presentation_TN_OD' + "'"
        CLMPlayer.fetchWithParams(
            "SELECT DRL_ProductMessage__c, DRL_SequenceName__c, DRL_Product__c, DRL_Product__r.Name, DRL_DefaultSequenceOrder__c, DRL_MasterPresentationName__c FROM DRL_SequenceProductMessage__c WHERE DRL_MasterPresentationName__c =" + AllpresentationNameNew + "AND DRL_DefaultSequenceOrder__c > 100 order by DRL_DefaultSequenceOrder__c",
            "{‘batchSize‘: 100}",
            "getRecordCountCallback"
        );
    }

    function getRecordCountCallback(data) {
        if (data.state === "success") {
            try {
                RecordLegth = data.totalSize;
                if (RecordLegth > 99) {
                    // Firstrecord = data.records[0].DRL_SequenceName__c;
                    for (i = 0; i < data.records.length; i++) {
                        DRLSequenceName.push(data.records[i].DRL_SequenceName__c);
                        DRLProduct.push(data.records[i].DRL_Product__c);
                        DRLOrder.push(data.records[i].DRL_DefaultSequenceOrder__c);
                        DRLProductMessage.push(data.records[i].DRL_ProductMessage__c);
                        DRLProductName.push(data.records[i]['DRL_Product__r.Name']);
                    }
                    drlTotalData = drlTotalData + data.records.length;
                    getAdditionalData();
                } else {

                    for (i = 0; i < data.records.length; i++) {
                        DRLSequenceName.push(data.records[i].DRL_SequenceName__c);
                        DRLProduct.push(data.records[i].DRL_Product__c);
                        DRLOrder.push(data.records[i].DRL_DefaultSequenceOrder__c);
                        DRLProductMessage.push(data.records[i].DRL_ProductMessage__c);
                        DRLProductName.push(data.records[i]['DRL_Product__r.Name']);
                    }
                    drlTotalData = drlTotalData + data.records.length;
                    getAccountRecords();
                    callTrackingFunctions()
                }
            } catch (err) {
                // CLMPlayer.alert("some issue occured here" + err);
            }
        } else {
            // CLMPlayer.alert("error occured");
        }
    }
    function callTrackingFunctions() {
        fetchProductmessageAfterUpser();
        fetchOCECallPresentation();
        fetchCallDetails(); // this will fetch call details
    }

    getRecordCount(); // to be commented for local testing


</script>

<script src="js/common.js"></script>
<script>
    let allData = {{{.}}}
</script>